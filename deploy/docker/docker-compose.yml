version: '3.8'

services:
  # MySQL 数据库
  db:
    image: mysql:8.0
    container_name: wanderflow-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-password}
      MYSQL_DATABASE: ${DB_NAME:-wanderflow}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-password}"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - wanderflow-network

  # Redis 缓存（可选）
  redis:
    image: redis:7-alpine
    container_name: wanderflow-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - wanderflow-network

  # 后端服务
  backend:
    build:
      context: ${PWD}/../../
      dockerfile: deploy/docker/backend/Dockerfile
    container_name: wanderflow-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # 数据库配置
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: ${DB_PASSWORD:-password}
      DB_NAME: ${DB_NAME:-wanderflow}
      # JWT 配置
      SECRET_KEY: ${SECRET_KEY:-your-secret-key}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-10080}
      # AI 配置
      ANTHROPIC_AUTH_TOKEN: ${ANTHROPIC_AUTH_TOKEN:-}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      ANTHROPIC_DEFAULT_OPUS_MODEL: ${ANTHROPIC_DEFAULT_OPUS_MODEL:-claude-opus-4-20250514}
      ANTHROPIC_DEFAULT_SONNET_MODEL: ${ANTHROPIC_DEFAULT_SONNET_MODEL:-claude-sonnet-4-20250514}
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      # 应用配置
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800}
      # 第三方服务
      MAP_API_KEY: ${MAP_API_KEY:-}
      MAP_SECRET_KEY: ${MAP_SECRET_KEY:-}
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}
      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-*}
    env_file:
      - .env
    volumes:
      - static_data:/app/static
      - backend_logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - wanderflow-network

  # 前端服务
  frontend:
    build:
      context: ${PWD}/../../
      dockerfile: deploy/docker/frontend/Dockerfile
    container_name: wanderflow-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - wanderflow-network

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: wanderflow-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/production.conf:/etc/nginx/conf.d/default.conf:ro
      - static_data:/var/www/static:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - wanderflow-network
    command: >
      sh -c "
        echo 'server {
            listen 80;
            server_name _;

            gzip on;
            gzip_vary on;
            gzip_min_length 1024;
            gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

            location / {
                proxy_pass http://frontend:80;
                proxy_http_version 1.1;
                proxy_set_header Host \$\$host;
                proxy_set_header X-Real-IP \$\$remote_addr;
                proxy_set_header X-Forwarded-For \$\$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$\$scheme;
            }

            location /api/ {
                proxy_pass http://backend:8000;
                proxy_http_version 1.1;
                proxy_set_header Host \$\$host;
                proxy_set_header X-Real-IP \$\$remote_addr;
                proxy_set_header X-Forwarded-For \$\$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$\$scheme;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            location /ws/ {
                proxy_pass http://backend:8000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$\$http_upgrade;
                proxy_set_header Connection \"upgrade\";
                proxy_set_header Host \$\$host;
            }

            location /static/ {
                proxy_pass http://backend:8000;
                proxy_set_header Host \$\$host;
            }

            location /health {
                return 200 \"OK\";
                add_header Content-Type text/plain;
            }
        }' > /etc/nginx/conf.d/default.conf
        && nginx -g \"daemon off;\"
      "

networks:
  wanderflow-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  static_data:
    driver: local
  backend_logs:
    driver: local
  nginx_logs:
    driver: local
