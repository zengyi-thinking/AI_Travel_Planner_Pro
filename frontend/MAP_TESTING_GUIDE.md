# 地图标记和路线功能测试指南

## ✅ 已完成的优化

### 1. **地图尺寸优化**
- 原高度: 500px → 新高度: 320px ⬇️ 减少 36%

### 2. **每一天使用不同颜色的路线**
| 天数 | 路线颜色 | 颜色代码 |
|------|---------|---------|
| 第1天 | 🔴 红色 | #ef4444 |
| 第2天 | 🔵 蓝色 | #3b82f6 |
| 第3天 | 🟢 绿色 | #10b981 |
| 第4天 | 🟠 橙色 | #f59e0b |
| 第5天 | 🟣 紫色 | #8b5cf6 |
| 第6天 | 🩷 粉色 | #ec4899 |
| 第7天 | 🔷 青色 | #06b6d4 |

### 3. **增强功能**
- ✅ 详细调试日志（浏览器控制台）
- ✅ 路线颜色图例（右上角显示）
- ✅ 活动类型图例（景点、美食、住宿、交通）
- ✅ 点击标记查看详情
- ✅ 天数切换功能
- ✅ 全屏查看模式

---

## 🎨 地图显示效果

```
┌─────────────────────────────────────────┐
│  活动类型  ☐     路线颜色  🗓️ 天数  ⛶   │
│  ┌─────┐  ┌─────┐  ┌─────┐  [第1天]   │
│  │📍景点│  │🔴第1天│ │ [第2天]   │
│  │🍜美食│  │🔵第2天│ │ [第3天]   │
│  │🏨住宿│  │🟢第3天│ │ [全部]    │
│  └─────┘  └─────┘  └─────┘            │
├─────────────────────────────────────────┤
│                                         │
│    📍故宫──→🍜烤鸭──→📍广场──→🏨酒店  │
│     (红色虚线路线)                     │
│                                         │
│           📍长城──→🍜农家菜           │
│              (蓝色虚线路线)            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 🔍 调试信息

### 浏览器控制台日志示例

当你打开地图时，控制台会显示：

```
🗺️ 开始添加标记点和路线
行程数据: { title: "北京3日游", days_detail: [...] }
选中天数: 全部, 共 3 天

处理第1天: 故宫周边深度游, 活动数: 4
  ✅ 添加标记: 故宫博物院 (39.9274, 116.4020)
  ✅ 添加标记: 全聚德烤鸭店 (39.9001, 116.3970)
  ✅ 添加标记: 天安门广场 (39.9348, 116.4224)
  ✅ 添加标记: 北京饭店 (39.9155, 116.4101)
  🔗 绘制第1天路线: #ef4444, 4个点

处理第2天: 长城一日游, 活动数: 2
  ✅ 添加标记: 八达岭长城 (40.3584, 116.0169)
  ✅ 添加标记: 长城脚下农家菜 (40.3591, 116.0185)
  🔗 绘制第2天路线: #3b82f6, 2个点

处理第3天: 颐和园漫步, 活动数: 2
  ✅ 添加标记: 颐和园 (40.0081, 116.2844)
  ✅ 添加标记: 颐和园附近餐厅 (40.0092, 116.2831)
  🔗 绘制第3天路线: #10b981, 2个点

📊 总计添加: 8 个标记, 3 条路线
✅ 地图视图已调整
```

### 如果没有看到标记

可能原因和解决方法：

#### 1️⃣ **缺少坐标数据**
```
控制台会显示:
  ⚠️ 活动缺少坐标: 故宫博物院
  ⚠️ 活动缺少坐标: 天安门广场
```

**原因**: AI 生成行程后，百度地图 API 没有成功获取坐标

**解决方法**:
- 检查后端日志是否有坐标获取成功的记录
- 确认百度地图 API Key 配置正确
- 查看是否有 "📍 地理坐标添加完成" 的日志

#### 2️⃣ **数据结构问题**
```
控制台会显示:
⚠️ 第1天没有活动数据
```

**原因**: 行程数据结构不正确

**解决方法**:
- 刷新页面重新生成行程
- 检查后端返回的数据格式

#### 3️⃣ **图层被禁用**
```
控制台会显示:
⊘ 图层已禁用: attraction
```

**原因**: 活动类型图层被关闭

**解决方法**:
- 点击右上角的图例，重新启用对应类型

---

## 🧪 测试步骤

### 第一步：生成新行程

1. 访问: http://localhost:3002
2. 登录系统
3. 填写行程信息:
   - 目的地: **北京**
   - 天数: **3**
   - 预算: **5000**
4. 点击「生成行程」
5. 等待 AI 生成详细行程（约 2-3 分钟）

### 第二步：检查后端日志

生成详细行程时，后端应该显示：

```bash
# 开始生成
开始生成详细行程: 北京 3天

# AI 返回行程
AI返回3天的数据

# 开始获取坐标
✅ 已获取坐标: 故宫博物院 -> (116.40, 39.93)
✅ 已获取坐标: 全聚德烤鸭店 -> (116.40, 39.90)
✅ 已获取坐标: 天安门广场 -> (116.42, 39.93)
...

# 完成
📍 地理坐标添加完成
详细行程生成完成，行程ID: XX
```

### 第三步：查看前端地图

1. 生成完成后，地图会自动显示
2. 应该看到:
   - ✅ 多个彩色标记点（红色、橙色、蓝色等）
   - ✅ 彩色虚线连接各点
   - ✅ 右上角有图例
   - ✅ 每天路线颜色不同

### 第四步：测试交互功能

1. **点击标记点**
   - 应该弹出详情窗口
   - 显示活动时间、地址、费用等

2. **切换天数**
   - 点击"第1天"按钮
   - 只显示第1天的标记和红色路线
   - 点击"全部"按钮恢复显示所有

3. **切换图层**
   - 点击"景点"图例
   - 隐藏/显示所有景点标记

4. **全屏查看**
   - 点击全屏按钮
   - 地图放大到全屏

---

## 🛠️ 调试技巧

### 打开浏览器控制台

**Chrome**:
1. 按 F12
2. 切换到"Console"标签

**查看日志**:
- 搜索 "🗺️" - 查看地图初始化
- 搜索 "✅" - 查看成功添加的标记
- 搜索 "⚠️" - 查看警告信息
- 搜索 "🔗" - 查看绘制的路线

### 检查网络请求

1. 打开开发者工具 (F12)
2. 切换到"Network"标签
3. 生成行程时观察请求

应该看到:
- `POST /api/v1/planner/generate` - 创建基础行程
- `POST /api/v1/planner/itineraries/:id/generate-detail` - 生成详细行程
- 返回的 JSON 中 `days_detail[].activities[].coordinates` 应该包含坐标

---

## 📊 预期数据结构

### 后端返回的行程数据

```json
{
  "id": 98,
  "title": "南昌3日休闲游",
  "destination": "南昌",
  "days_detail": [
    {
      "day_number": 1,
      "title": "历史文化之旅",
      "activities": [
        {
          "time": "09:00",
          "title": "滕王阁",
          "type": "attraction",
          "location": "江西省南昌市东湖区仿古街58号",
          "coordinates": {
            "lng": 115.892211,
            "lat": 28.682448
          }
        },
        {
          "time": "12:00",
          "title": "瓦罐汤店",
          "type": "meal",
          "location": "南昌市东湖区",
          "coordinates": {
            "lng": 115.888145,
            "lat": 28.679234
          }
        }
      ]
    }
  ]
}
```

---

## ❓ 常见问题

### Q1: 地图显示空白？

**检查**:
1. 打开浏览器控制台是否有错误
2. 确认行程已生成详细行程
3. 查看是否有"活动缺少坐标"的警告

### Q2: 只看到标记点，没有路线？

**原因**: 当天只有1个活动，无法绘制路线

**正常**: 如果某天只有1个活动，不会有连线

### Q3: 所有路线都是同一种颜色？

**检查**:
1. 是否选择了特定天数？
2. 点击"全部"按钮应该显示多条不同颜色的路线
3. 查看路线颜色图例是否正确显示

### Q4: 标记点位置不对？

**原因**:
- 百度地图坐标有偏移（正常现象）
- OpenStreetMap 底图使用 WGS84 坐标系
- 百度地图使用 BD09 坐标系

**影响**:
- 标记点可能会有 50-200 米的偏移
- 不影响整体使用，相对位置是正确的

---

## ✅ 成功示例

### 3天北京行程

```
第1天 (红色路线):
  故宫 → 烤鸭店 → 天安门 → 酒店

第2天 (蓝色路线):
  八达岭长城 → 农家菜

第3天 (绿色路线):
  颐和园 → 颐和园餐厅
```

每个标记点:
- 🔴 景点 = 红色圆点 + 相机图标
- 🟠 美食 = 橙色圆点 + 餐具图标
- 🔵 住宿 = 蓝色圆点 + 床图标

---

## 🎯 总结

**已实现功能**:
- ✅ 地图尺寸优化（320px）
- ✅ 每天路线不同颜色
- ✅ 路线颜色图例
- ✅ 详细调试日志
- ✅ 标记点显示
- ✅ 点击查看详情
- ✅ 天数切换
- ✅ 图层筛选

**立即测试**:
1. 生成新行程
2. 等待坐标获取完成
3. 查看地图彩色标记和路线
4. 尝试各种交互功能
