name: CD - è‡ªåŠ¨éƒ¨ç½²

on:
  workflow_run:
    workflows: [CI - æµ‹è¯•ä¸æ„å»º]
    types:
      - completed
    branches: [main]

jobs:
  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: docker
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€æœ€æ–°é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}-backend:latest

      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}-frontend:latest

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd wanderflow

            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin main

            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ env.REGISTRY }}/${{ github.repository }}-backend:latest
            docker pull ${{ env.REGISTRY }}/${{ github.repository }}-frontend:latest

            # é‡æ–°å¯åŠ¨æœåŠ¡
            cd deploy/docker
            docker-compose down
            docker-compose up -d

            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f

            echo "éƒ¨ç½²å®Œæˆï¼"

      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        uses: appleboy/telegram-action@v1.0.3
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: |
            ğŸš€ WanderFlow éƒ¨ç½²é€šçŸ¥
            çŠ¶æ€: ${{ job.status }}
            åˆ†æ”¯: main
            æ—¶é—´: ${{ github.event.head_commit.timestamp }}
            æŸ¥çœ‹: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
